{% extends 'UserPage/Admin/index.html.twig' %} {% block title %}Users & Roles{%
endblock %} {% block admin_content %}
<section
    x-data='{
        openModal: false,
        modalHtml: "",
        isLoading: false,

        search: "",
        filter: "",

        loadModal(url) {
            this.openModal = true;
            this.isLoading = true;

            this.modalHtml = `
                <div class="flex items-center justify-center py-10 text-gray-500">
                    <svg class="animate-spin h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    Loading...
                </div>`;

            fetch(url)
                .then(r => r.text())
                .then(html => {
                    this.modalHtml = html;
                    this.isLoading = false;
                })
                .catch(err => {
                    console.error(err);
                    this.modalHtml = `
                        <div class="text-center py-10 text-red-500">
                            Error loading content.
                        </div>`;
                    this.isLoading = false;
                });
        }
    }'
    class="space-y-4"
>
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
    >
        <div>
            <h2 class="text-xl font-semibold">Users & Roles</h2>
            <p class="text-sm text-gray-500">
                Manage user accounts, ranks, and roles
            </p>
        </div>

        <div class="flex items-center gap-2">
            <input
                type="text"
                placeholder="Search users..."
                x-model="search"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none w-64 text-sm"
            />

            <select
                x-model="filter"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
            >
                <option value="">All</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
                <option value="officer">Officer</option>
            </select>

            <button
                @click="loadModal('{{ path('app_user_roles_new') }}')"
                class="px-3 py-2 bg-primary text-white rounded-lg text-sm shadow hover:scale-105 transition-transform"
            >
                + New User
            </button>
        </div>
    </div>

    <!-- Table -->
    <div
        class="mt-2 overflow-x-auto bg-white rounded-xl shadow max-h-[500px] overflow-y-auto"
    >
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead
                class="bg-gray-100 text-gray-700 uppercase text-xs tracking-wider sticky top-0 z-10"
            >
                <tr>
                    <th class="px-4 py-3 text-left">Full Name</th>
                    <th class="px-4 py-3 text-left">Email</th>
                    <th class="px-4 py-3 text-left">Rank</th>
                    <th class="px-4 py-3 text-left">Created At</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                </tr>
            </thead>

            <tbody
                class="divide-y divide-gray-100"
                x-data="{
                    visibleCount: 0,
                    updateVisible(change) {
                        this.visibleCount += change;
                    }
                }"
            >
                {% if users is defined and users|length > 0 %} {% for user in
                users %}
                <tr
                    x-data="{
                                fullName: '{{ user.fullName|lower|e('js') }}',
                                roleList: '{{ user.roles|join(', ')|lower|e('js') }}',
                                isVisible: false
                            }"
                    x-show="
                                (fullName.includes(search.toLowerCase()) ||
                                roleList.includes(search.toLowerCase())) &&
                                (filter === '' || roleList.includes(filter))
                            "
                    x-init="
                                $watch(() => (
                                    (fullName.includes(search.toLowerCase()) ||
                                    roleList.includes(search.toLowerCase())) &&
                                    (filter === '' || roleList.includes(filter))
                                ), value => {
                                    if (value && !isVisible) {
                                        isVisible = true;
                                        $root.updateVisible(1);
                                    } else if (!value && isVisible) {
                                        isVisible = false;
                                        $root.updateVisible(-1);
                                    }
                                });
                            "
                    class="hover:bg-gray-50 transition-colors"
                >
                    <td class="px-4 py-3 font-medium text-gray-900">
                        {{ user.fullName }}
                    </td>
                    <td class="px-4 py-3 text-gray-700">{{ user.email }}</td>
                    <td class="px-4 py-3 text-gray-700">
                        {{ user.userRank ? user.userRank.name : "N/A" }}
                    </td>
                    <td class="px-4 py-3 text-gray-500">
                        {{ user.createdAt ? user.createdAt|date('Y-m-d H:i') : 'N/A' }}
                    </td>
                    <td class="px-4 py-2 space-x-3">
                        {{
                            include(
                                "UserPage/Admin/forms/user_roles/_actions_link.html.twig"
                            )
                        }}
                    </td>
                </tr>
                {% endfor %}

                <!-- Dynamic Empty Message -->
                <tr
                    x-show="visibleCount === 0"
                    x-transition.opacity.duration.300ms
                >
                    <td
                        colspan="7"
                        class="px-4 py-6 text-center text-gray-500 italic"
                    >
                        <template x-if="filter === '' && search.trim() !== ''">
                            <span>No users match your search</span>
                        </template>
                        <template x-if="filter !== '' && visibleCount === 0">
                            <span>No users found for selected role</span>
                        </template>
                        <template x-if="filter === '' && search.trim() === ''">
                            <span>See Next Page</span>
                        </template>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-4 py-6 text-center text-gray-400">
                        No users found.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if users is defined and users|length > 0 %}
    <div class="flex justify-center mt-4">
        {{ knp_pagination_render(users) }}
    </div>
    {% endif %}

    <!-- Modal -->
    {% include 'UserPage/Admin/modals/_openModal.html.twig' %}
</section>
{% endblock %}
