{% extends 'UserPage/Admin/index.html.twig' %} {% block title %}Users & Roles{%
endblock %} {% block admin_content %}
<section
    x-data='{
        openModal: false,
        modalHtml: "",
        isLoading: false,

        search: "",
        filter: "",

        loadModal(url) {
            this.openModal = true;
            this.isLoading = true;

            this.modalHtml = `
                <div class="flex items-center justify-center py-10 text-gray-500">
                    <svg class="animate-spin h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    Loading...
                </div>`;

            fetch(url)
                .then(r => r.text())
                .then(html => {
                    this.modalHtml = html;
                    this.isLoading = false;
                })
                .catch(err => {
                    console.error(err);
                    this.modalHtml = `
                        <div class="text-center py-10 text-red-500">
                            Error loading content.
                        </div>`;
                    this.isLoading = false;
                });
        }
    }'
    class="space-y-4"
>
    <!-- Header -->
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
    >
        <div>
            <h2 class="text-xl font-semibold">Users & Roles</h2>
            <p class="text-sm text-gray-500">
                Manage user accounts, ranks, and roles
            </p>
        </div>

        <div class="flex items-center gap-2">
            <input
                type="text"
                placeholder="Search users..."
                x-model="search"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none w-64 text-sm"
            />

            <select
                x-model="filter"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
            >
                <option value="">All</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
                <option value="officer">Officer</option>
            </select>

            <button
                @click="loadModal('{{ path('app_user_roles_new') }}')"
                class="px-3 py-2 bg-primary text-white rounded-lg text-sm"
            >
                + New User
            </button>
        </div>
    </div>

    <!-- Table -->
    <div
        class="mt-2 overflow-x-auto bg-white rounded-2xl shadow max-h-[500px] overflow-y-auto"
    >
        <table class="min-w-full text-sm divide-y divide-gray-200">
            <thead
                class="bg-gray-100 text-gray-700 uppercase text-xs tracking-wider sticky top-0 z-10"
            >
                <tr>
                    <th class="px-4 py-3 text-left">Full Name</th>
                    <th class="px-4 py-3 text-left">Email</th>
                    <th class="px-4 py-3 text-left">Rank</th>
                    <th class="px-4 py-3 text-left">Created At</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                </tr>
            </thead>

            <tbody class="divide-y divide-gray-100">
                {% if users is defined and users|length > 0 %} {% for user in
                users %}
                <tr
                    class="hover:bg-gray-50"
                    x-data="{
                                fullName: '{{ user.fullName | lower }}',
                                roleList: '{{ user.roles|join(', ')|lower }}',
                            }"
                    x-show="
                                fullName.includes(search.toLowerCase()) ||
                                roleList.includes(search.toLowerCase())
                            && (filter === '' || roleList.includes(filter))
                            "
                >
                    <td class="px-4 py-3 font-medium text-gray-900">
                        {{ user.fullName }}
                    </td>
                    <td class="px-4 py-3 text-gray-700">{{ user.email }}</td>
                    <td class="px-4 py-3 text-gray-700">
                        {{ user.userRank ? user.userRank.name : "N/A" }}
                    </td>
                    <td class="px-4 py-3 text-gray-500">
                        {{ user.createdAt ? user.createdAt|date('Y-m-d H:i') : 'N/A' }}
                    </td>
                    <td class="px-4 py-2 space-x-3">
                        {{
                            include(
                                "UserPage/Admin/forms/user_roles/_actions_link.html.twig"
                            )
                        }}
                    </td>
                </tr>
                {% endfor %} {% else %}
                <tr>
                    <td colspan="7" class="px-4 py-6 text-center text-gray-400">
                        No users found.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if users|length > 0 %}
    <div class="flex justify-center mt-4">
        {{ knp_pagination_render(users) }}
    </div>
    {% endif %}

    <!-- Modal -->
    <div
        x-show="openModal"
        class="fixed inset-0 flex items-center justify-center bg-black/20 backdrop-blur-md z-50"
        @click.self="openModal = false"
        x-transition.opacity
    >
        <div
            class="bg-white rounded-xl shadow-xl w-[500px] max-h-[80vh] overflow-y-auto p-6 transform transition-all duration-300"
            x-transition:enter="ease-out duration-200"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="ease-in duration-150"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            x-html="modalHtml"
        ></div>
    </div>

    {% include 'UserPage/Admin/_modals.html.twig' %}
</section>
{% endblock %}
